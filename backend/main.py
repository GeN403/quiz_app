# main.py
import os
import requests
from bs4 import BeautifulSoup
import google.generativeai as genai
from dotenv import load_dotenv
import json

# FastAPIé–¢é€£ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel

# .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
load_dotenv()
api_key = os.getenv("GEMINI_API_KEY")

# APIã‚­ãƒ¼ã‚’è¨­å®š
genai.configure(api_key=api_key)

# FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
app = FastAPI()

# CORSãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®è¨­å®šï¼ˆNext.jsã®localhost:3000ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ï¼‰
origins = [
    "http://localhost:3000",
]
app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
# ----------------------------------------------------
# â†“â†“â†“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ãƒ«ãƒ¼ãƒ«ã®å®šç¾© â†“â†“â†“
# ----------------------------------------------------

# ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®å‹ã‚’å®šç¾©
class QuizRequest(BaseModel):
    url: str

# # ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠï¼ˆå®Ÿéš›ã«åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«åã«ã—ã¦ãã ã•ã„ï¼‰
# model = genai.GenerativeModel('gemini-2.5-flash')

# # ã‚¯ã‚¤ã‚ºã®ç”Ÿæˆå…ƒã¨ãªã‚‹ãƒšãƒ¼ã‚¸ã®URL
# target_url = "https://kotobank.jp/word/%E5%B1%B1%E6%9D%B1%E4%BA%AC%E4%BC%9D-18131"

# # åˆ¶ç´„æ¡ä»¶ã‚’ç‹¬ç«‹ã—ãŸå¤‰æ•°ã¨ã—ã¦å®šç¾©ï¼ˆå†åˆ©ç”¨ã™ã‚‹ãŸã‚ï¼‰
# CONSTRAINT_RULES = """
# ãƒ»å¿…ãšã€Œå•é¡Œæ–‡ã€ã€Œæ­£è§£ã€ã€Œåˆ¥è§£/æ­£èª¤åˆ¤å®šåŸºæº–ã€ã€Œè§£èª¬ã€ã€Œå‡ºå…¸ã€ã®è¦ç´ ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
# ãƒ»å‡ºåŠ›ã¯JSONå½¢å¼ã§ã€ä»¥ä¸‹ã®ã‚­ãƒ¼ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ãã ã•ã„: "question", "answer", "Alternative Solutions/Correctness Judgment Criteria", "explanation","source"
# ãƒ»"source"ã«ã¯ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã¨URLã‚’å«ã‚ã¦ãã ã•ã„ã€‚
# ãƒ»"question"ã§ã¯å•é¡Œã®å¾ŒåŠã§å•é¡Œã®ç­”ãˆã‚’ä¸€æ„ã«çµã‚Œã‚‹ã‚ˆã†ãªæƒ…å ±ã‚’ç››ã‚Šè¾¼ã‚“ã§ãã ã•ã„ã€‚
# ãƒ»"Alternative Solutions/Correctness Judgment Criteria"ã«ã¤ã„ã¦ã¯æ—¥æœ¬èªã§ã®å‘¼ã³æ–¹ã¨å¤–æ¥èªã¨ã—ã¦ã®å‘¼ã³æ–¹ã®ä¸¡æ–¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€åˆ¥è§£ã¨ã—ã¦ã€Œåˆ¥è§£/æ­£èª¤åˆ¤å®šåŸºæº–ã€æ¬„ã«ãã®æ—¨ã‚’è¨˜è¼‰ã™ã‚‹ã‹ã€ã©ã¡ã‚‰ã‹ä¸€æ–¹ã«é™å®šã§ãã‚‹å•é¡Œæ–‡ã«æ”¹ã‚ã¦ãã ã•ã„ã€‚
# ãƒ»"question"ã®æ–‡æœ«ã¯ã€Œï½ã§ã—ã‚‡ã†ï¼Ÿã€ã¨ã—ã¦ãã ã•ã„ã€‚
# ãƒ»"question"ã®ä¸­ã§ã‚‚ã€ã€Œæ—¥æœ¬ã§ä¸€ç•ªé«˜ã„å±±ã¯å¯Œå£«å±±ã§ã™ãŒã€ä¸–ç•Œã§ä¸€ç•ªé«˜ã„å±±ã¯ä½•ã§ã—ã‚‡ã†ï¼Ÿã€ã®ã‚ˆã†ãªå‰åŠã¨å¾ŒåŠãŒå¯¾ç…§çš„ãªå•é¡Œï¼ˆãƒ‘ãƒ©ãƒ¬ãƒ«å•é¡Œï¼‰ã¯ã€Œï½ã§ã™ãŒã€ï½ã€ã¨ã™ã‚‹ã€‚
# ãƒ»"question"ã®ä¸­ã§ã‚‚ã€ãƒ‘ãƒ©ãƒ¬ãƒ«å•é¡Œã§ã¯å¯¾ç…§çš„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’**å¼·èª¿**ã—ã¦ãã ã•ã„ã€‚
# ãƒ»ä½“è¨€æ­¢ã‚ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
# ãƒ»ä½œå“åã¯ã€ã€ï¼ˆ2é‡éµã‹ã£ã“ï¼‰ã§å›²ã‚“ã§ãã ã•ã„ã€‚
# ãƒ»"question"ã§ã¯å•é¡Œæ–‡ã¯80æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚
# ãƒ»æ¼¢å­—æ¤œå®š2ç´šç¨‹åº¦ã®èªå½™ã«ã¯å¾Œã‚ã‹ã‚‰()ã§ãƒ«ãƒ“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
# ãƒ»æœ€åˆã¯åºƒã„æƒ…å ±ã‹ã‚‰å…¥ã‚Šã€å¾ã€…ã«ç‹­ã„æƒ…å ±ã«çµã£ã¦ãã ã•ã„ã€‚
# ãƒ»å‰åŠã«çŸ¥ååº¦ãŒä½ã„æƒ…å ±ã€å¾ŒåŠã«çŸ¥ååº¦ãŒé«˜ã„æƒ…å ±ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚
# """

# # --- â‘  ç”Ÿæˆãƒ•ã‚§ãƒ¼ã‚ºç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ---
# prompt_template_generate = f"""
# # å½¹å‰²
# ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚¯ã‚¤ã‚ºä½œå®¶ã§ã™ã€‚

# # ã‚¿ã‚¹ã‚¯
# ä»¥ä¸‹ã®æ–‡ç« ã‚’åŸºã«ã—ã¦ã€ç«¶æŠ€ã‚¯ã‚¤ã‚ºã§ä½¿ãˆã‚‹ã‚ˆã†ãªæœ¬æ ¼çš„ãªã‚¯ã‚¤ã‚ºã‚’1å•ä½œæˆã—ã¦ãã ã•ã„ã€‚

# # åˆ¶ç´„æ¡ä»¶
# {CONSTRAINT_RULES}

# # æ–‡ç« 
# {{source_text}}
# """

# # --- â‘¡ è‡ªå·±è©•ä¾¡ãƒ»ä¿®æ­£ãƒ•ã‚§ãƒ¼ã‚ºç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ---
# prompt_template_refine = f"""
# # å½¹å‰²
# ã‚ãªãŸã¯ã€AIãŒç”Ÿæˆã—ãŸã‚¯ã‚¤ã‚ºã‚’è©•ä¾¡ã—ã€ä¿®æ­£ã™ã‚‹å“è³ªä¿è¨¼ã®å°‚é–€å®¶ã§ã™ã€‚

# # ã‚¿ã‚¹ã‚¯
# AIãŒç”Ÿæˆã—ãŸä»¥ä¸‹ã®ã€Œç”Ÿæˆç‰©ã€ãŒã€ã€Œåˆ¶ç´„æ¡ä»¶ã€ã‚’å®Œå…¨ã«æº€ãŸã—ã¦ã„ã‚‹ã‹å³å¯†ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
# ã‚‚ã—ä¸€ã¤ã§ã‚‚é•åãŒã‚ã‚Œã°ã€ã™ã¹ã¦ã®é•åç®‡æ‰€ã‚’ä¿®æ­£ã—ã€åˆ¶ç´„æ¡ä»¶ã‚’å®Œå…¨ã«æº€ãŸã—ãŸ**æœ€çµ‚çš„ãªJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’å‡ºåŠ›**ã—ã¦ãã ã•ã„ã€‚
# ã‚‚ã—é•åãŒãªã‘ã‚Œã°ã€å…ƒã®ã€Œç”Ÿæˆç‰©ã€ã‚’**ãã®ã¾ã¾JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å‡ºåŠ›**ã—ã¦ãã ã•ã„ã€‚

# **é‡è¦ï¼šã‚ãªãŸã®å¿œç­”ã¯ã€è§£èª¬ã‚„æŒ¨æ‹¶ã‚’ä¸€åˆ‡å«ã‚“ã§ã¯ã„ã‘ã¾ã›ã‚“ã€‚ã‚ãªãŸã®å¿œç­”ã¯ã€JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãã®ã‚‚ã®ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚**

# # åˆ¶ç´„æ¡ä»¶
# {CONSTRAINT_RULES}

# # AIã«ã‚ˆã‚‹ç”Ÿæˆç‰©
# {{draft_quiz}}
# """

# ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ
model = genai.GenerativeModel('gemini-2.0-flash-lite')

# åˆ¶ç´„æ¡ä»¶ã‚’ç‹¬ç«‹ã—ãŸå¤‰æ•°ã¨ã—ã¦å®šç¾©
CONSTRAINT_RULES = """
ãƒ»å¿…ãšã€Œå•é¡Œæ–‡ã€ã€Œæ­£è§£ã€ã€Œåˆ¥è§£/æ­£èª¤åˆ¤å®šåŸºæº–ã€ã€Œè§£èª¬ã€ã€Œå‡ºå…¸ã€ã®è¦ç´ ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
ãƒ»å‡ºåŠ›ã¯JSONå½¢å¼ã§ã€ä»¥ä¸‹ã®ã‚­ãƒ¼ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ãã ã•ã„: "question", "answer", "Alternative Solutions/Correctness Judgment Criteria", "explanation","source"
ãƒ»"source"ã«ã¯ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã¨URLã‚’å«ã‚ã¦ãã ã•ã„ã€‚
ãƒ»å•é¡Œã®å¾ŒåŠã§å•é¡Œã®ç­”ãˆã‚’ä¸€æ„ã«çµã‚Œã‚‹ã‚ˆã†ãªæƒ…å ±ã‚’ç››ã‚Šè¾¼ã‚“ã§ãã ã•ã„ã€‚
ãƒ»æ—¥æœ¬èªã§ã®å‘¼ã³æ–¹ã¨å¤–æ¥èªã¨ã—ã¦ã®å‘¼ã³æ–¹ã®ä¸¡æ–¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€åˆ¥è§£ã¨ã—ã¦ã€Œåˆ¥è§£/æ­£èª¤åˆ¤å®šåŸºæº–ã€æ¬„ã«ãã®æ—¨ã‚’è¨˜è¼‰ã™ã‚‹ã‹ã€ã©ã¡ã‚‰ã‹ä¸€æ–¹ã«é™å®šã§ãã‚‹å•é¡Œæ–‡ã«æ”¹ã‚ã¦ãã ã•ã„ã€‚
ãƒ»æ–‡æœ«ã¯ã€Œï½ã§ã—ã‚‡ã†ï¼Ÿã€ã¨ã—ã¦ãã ã•ã„ã€‚
ãƒ»ã€Œæ—¥æœ¬ã§ä¸€ç•ªé«˜ã„å±±ã¯å¯Œå£«å±±ã§ã™ãŒã€ä¸–ç•Œã§ä¸€ç•ªé«˜ã„å±±ã¯ä½•ã§ã—ã‚‡ã†ï¼Ÿã€ã®ã‚ˆã†ãªå‰åŠã¨å¾ŒåŠãŒå¯¾ç…§çš„ãªå•é¡Œï¼ˆãƒ‘ãƒ©ãƒ¬ãƒ«å•é¡Œï¼‰ã¯ã€Œï½ã§ã™ãŒã€ï½ã€ã¨ã™ã‚‹ã€‚
ãƒ»ãƒ‘ãƒ©ãƒ¬ãƒ«å•é¡Œã§ã¯å¯¾ç…§çš„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’**å¼·èª¿**ã—ã¦ãã ã•ã„ã€‚
ãƒ»ä½“è¨€æ­¢ã‚ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
ãƒ»ä½œå“åã¯ã€ã€ï¼ˆ2é‡éµã‹ã£ã“ï¼‰ã§å›²ã‚“ã§ãã ã•ã„ã€‚
ãƒ»å•é¡Œæ–‡ã¯80æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚
ãƒ»æ¼¢å­—æ¤œå®š2ç´šç¨‹åº¦ã®èªå½™ã«ã¯å¾Œã‚ã‹ã‚‰()ã§ãƒ«ãƒ“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
ãƒ»æœ€åˆã¯åºƒã„æƒ…å ±ã‹ã‚‰å…¥ã‚Šã€å¾ã€…ã«ç‹­ã„æƒ…å ±ã«çµã£ã¦ãã ã•ã„ã€‚
ãƒ»å‰åŠã«çŸ¥ååº¦ãŒä½ã„æƒ…å ±ã€å¾ŒåŠã«çŸ¥ååº¦ãŒé«˜ã„æƒ…å ±ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚
"""

# --- â‘  AIã¸ã®æœ€çµ‚çš„ãªæŒ‡ç¤ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆã“ã‚Œä¸€æœ¬ã«ã—ã¾ã™ï¼‰ ---
prompt_template = f"""
# å½¹å‰²
ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚¯ã‚¤ã‚ºä½œå®¶ã§ã‚ã‚Šã€JSONã®å°‚é–€å®¶ã§ã™ã€‚

# ã‚¿ã‚¹ã‚¯
ä»¥ä¸‹ã®ã€Œæ–‡ç« ã€ã¨ã€Œå‡ºå…¸æƒ…å ±ã€ã‚’åŸºã«ã—ã¦ã€ç«¶æŠ€ã‚¯ã‚¤ã‚ºã§ä½¿ãˆã‚‹ã‚ˆã†ãªæœ¬æ ¼çš„ãªã‚¯ã‚¤ã‚ºã‚’1å•ä½œæˆã—ã¦ãã ã•ã„ã€‚

# åˆ¶ç´„æ¡ä»¶
{CONSTRAINT_RULES}

# æœ€é‡è¦ãƒ«ãƒ¼ãƒ«
ãƒ»ã‚ãªãŸã®å¿œç­”ã¯ã€è§£èª¬ã‚„æŒ¨æ‹¶ã‚’ä¸€åˆ‡å«ã‚“ã§ã¯ã„ã‘ã¾ã›ã‚“ã€‚
ãƒ»ã‚ãªãŸã®å¿œç­”ã¯ã€**ã€Œåˆ¶ç´„æ¡ä»¶ã€ã‚’ã™ã¹ã¦æº€ãŸã—ãŸJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãã®ã‚‚ã®**ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

# å‡ºå…¸æƒ…å ±
ãƒ»ã‚¿ã‚¤ãƒˆãƒ«: {{source_title}}
ãƒ»URL: {{source_url}}

# æ–‡ç« 
{{source_text}}
"""

# ----------------------------------------------------
# â†‘â†‘â†‘ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ãƒ«ãƒ¼ãƒ«ã®å®šç¾©ã“ã“ã¾ã§ â†‘â†‘â†‘
# ----------------------------------------------------

def get_web_info(url: str):
    """URLã‹ã‚‰æœ¬æ–‡ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°"""
    try:
        print(f"ğŸ“„ '{url}' ã‹ã‚‰æƒ…å ±ã‚’å–å¾—ä¸­...")
        response = requests.get(url, timeout=10)
        response.raise_for_status()
        
        soup = BeautifulSoup(response.content, 'html.parser')
        
        # ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
        title = soup.title.string if soup.title else "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜"
        
        for tag in soup(['script', 'style', 'header', 'footer', 'nav', 'aside']):
            tag.decompose()
        
        body_text = soup.get_text(separator='\n', strip=True)
        print("âœ… æƒ…å ±ã®å–å¾—å®Œäº†ï¼")
        return body_text, title
    except requests.RequestException as e:
        print(f"âŒ URLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
        return None, None
    

@app.post("/generate-quiz")
async def generate_quiz(request: QuizRequest):
    """
    URLã‚’å—ã‘å–ã‚Šã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã¨Gemini APIå‘¼ã³å‡ºã—ã‚’è¡Œã£ã¦ã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆã™ã‚‹
    """
    print(f"ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡: URL = {request.url}")
    
    # 1. URLã‹ã‚‰æœ¬æ–‡ã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
    source_text, source_title = get_web_info(request.url)
    if not source_text:
        raise HTTPException(status_code=400, detail="URLã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")

    # ãƒ†ã‚­ã‚¹ãƒˆãŒé•·ã™ãã‚‹ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹ãŸã‚ã€å…ˆé ­8000æ–‡å­—ç¨‹åº¦ã«åˆ¶é™ã™ã‚‹
    MAX_LENGTH = 8000
    if len(source_text) > MAX_LENGTH:
        print(f"âš ï¸ ãƒ†ã‚­ã‚¹ãƒˆãŒé•·ã™ããŸãŸã‚ã€{MAX_LENGTH}æ–‡å­—ã«çŸ­ç¸®ã—ã¾ã™ã€‚")
        source_text = source_text[:MAX_LENGTH]

    try:
        # --- AIå‘¼ã³å‡ºã—ï¼ˆ1å›ã ã‘ï¼‰ ---
        print("\n--- â‘  ç”Ÿæˆãƒ•ã‚§ãƒ¼ã‚º ---")
        full_prompt = prompt_template.format(
            source_title=source_title,
            source_url=request.url,
            source_text=source_text
        )
        print("ğŸ¤– AIã«ã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆã•ã›ã¦ã„ã¾ã™...")
        response = model.generate_content(full_prompt)
        
        # AIã®ç”Ÿã®å¿œç­”ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        final_text = response.text.strip()
        
        print("--- ğŸ¤– AIã®æœ€çµ‚RAWå¿œç­” (ãƒ‡ãƒãƒƒã‚°ç”¨) ---")
        print(final_text)
        print("---------------------------------")

        # AIãŒJSONã‚’```ã§å›²ã‚“ã§ã„ã‚‹å ´åˆã€ãã‚Œã‚’å–ã‚Šé™¤ã
        if final_text.startswith("```json"):
            final_text = final_text[7:].strip() # "```json\n" ã‚’å‰Šé™¤
        if final_text.startswith("```"):
            final_text = final_text[3:].strip()
        if final_text.endswith("```"):
            final_text = final_text[:-3].strip()
        
        print("âœ… æœ€çµ‚ç‰ˆãŒå®Œæˆã—ã¾ã—ãŸï¼(ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œ)")
        
        # JSONæ–‡å­—åˆ—ã‚’Pythonã®è¾æ›¸ã«å¤‰æ›ã—ã¦è¿”ã™
        final_json = json.loads(final_text)
        return final_json
        
    # ã‚¨ãƒ©ãƒ¼ã‚­ãƒ£ãƒƒãƒã‚’ã‚ˆã‚Šå…·ä½“çš„ã«ã™ã‚‹
    except json.JSONDecodeError as e:
        print(f"âŒ JSONãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: {e}")
        print("--- å¤±æ•—ã—ãŸãƒ†ã‚­ã‚¹ãƒˆ (ä¸Šè¨˜ãƒ­ã‚°å‚ç…§) ---")
        raise HTTPException(status_code=500, detail=f"AIãŒæœ‰åŠ¹ãªJSONã‚’è¿”ã—ã¾ã›ã‚“ã§ã—ãŸã€‚RAW: {final_text}")
    except Exception as e:
        print(f"âŒ APIå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        raise HTTPException(status_code=500, detail="AIã«ã‚ˆã‚‹ã‚¯ã‚¤ã‚ºç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")

# --- ãƒ¡ã‚¤ãƒ³ã®å‡¦ç† ---
# 1. URLã‹ã‚‰æœ¬æ–‡ã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
# source_text, source_title = get_web_info(target_url)

# if source_text:
#     # --- â‘  ç”Ÿæˆãƒ•ã‚§ãƒ¼ã‚º ---
#     print("\n--- â‘  ç”Ÿæˆãƒ•ã‚§ãƒ¼ã‚º ---")
#     prompt_generate = prompt_template_generate.format(source_text=source_text)
#     print("ğŸ¤– AIã«ã‚¯ã‚¤ã‚ºã®åˆç¨¿ã‚’ç”Ÿæˆã•ã›ã¦ã„ã¾ã™...")
#     response_generate = model.generate_content(prompt_generate)
#     first_draft_text = response_generate.text
#     print("âœ… åˆç¨¿ãŒå®Œæˆã—ã¾ã—ãŸï¼")
#     print(first_draft_text)

#     # --- â‘¡ è‡ªå·±è©•ä¾¡ãƒ»ä¿®æ­£ãƒ•ã‚§ãƒ¼ã‚º ---
#     print("\n--- â‘¡ è‡ªå·±è©•ä¾¡ãƒ»ä¿®æ­£ãƒ•ã‚§ãƒ¼ã‚º ---")
#     prompt_refine = prompt_template_refine.format(draft_quiz=first_draft_text)
#     print("ğŸ§ AIãŒç”Ÿæˆçµæœã‚’è‡ªå·±è©•ä¾¡ã—ã€å¿…è¦ãªã‚‰ä¿®æ­£ã—ã¾ã™...")
#     response_refine = model.generate_content(prompt_refine)
    
#     # æœ€çµ‚çš„ãªå‡ºåŠ›ã‚’æ•´å½¢
#     final_text = response_refine.text.strip().replace("```json\n", "").replace("\n```", "")
    
#     print("âœ… æœ€çµ‚ç‰ˆãŒå®Œæˆã—ã¾ã—ãŸï¼")
#     print("\n--- æœ€çµ‚å‡ºåŠ›çµæœ ---")
    
#     # JSONã¨ã—ã¦ãã‚Œã„ã«æ•´å½¢ã—ã¦è¡¨ç¤º
#     try:
#         final_json = json.loads(final_text)
#         print(json.dumps(final_json, indent=2, ensure_ascii=False))
#     except json.JSONDecodeError:
#         print("ã‚¨ãƒ©ãƒ¼: æœ€çµ‚å‡ºåŠ›ãŒæœ‰åŠ¹ãªJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")
#         print(final_text)
# APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä½œæˆ
# ----------------------------------------------------
# 

    # # AIã®ç”Ÿã®å¿œç­”ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    #     final_text = response_refine.text.strip()
        
    #     # (!!!) ãƒ‡ãƒãƒƒã‚°ã®ãŸã‚ã«ã€AIã®ç”Ÿã®å¿œç­”ã‚’ãƒ­ã‚°ã«å‡ºåŠ› (!!!)
    #     print("--- ğŸ¤– AIã®æœ€çµ‚RAWå¿œç­” (ãƒ‡ãƒãƒƒã‚°ç”¨) ---")
    #     print(final_text)
    #     print("---------------------------------")

    #     # AIãŒJSONã‚’```ã§å›²ã‚“ã§ã„ã‚‹å ´åˆã€ãã‚Œã‚’å–ã‚Šé™¤ã
    #     if final_text.startswith("```json"):
    #         final_text = final_text[7:].strip() # "```json\n" ã‚’å‰Šé™¤
    #     if final_text.startswith("```"):
    #         final_text = final_text[3:].strip()
    #     if final_text.endswith("```"):
    #         final_text = final_text[:-3].strip()
        
    #     print("âœ… æœ€çµ‚ç‰ˆãŒå®Œæˆã—ã¾ã—ãŸï¼(ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œ)")
        
    #     # JSONæ–‡å­—åˆ—ã‚’Pythonã®è¾æ›¸ã«å¤‰æ›ã—ã¦è¿”ã™
    #     final_json = json.loads(final_text)
    #     return final_json
        
    # # ã‚¨ãƒ©ãƒ¼ã‚­ãƒ£ãƒƒãƒã‚’ã‚ˆã‚Šå…·ä½“çš„ã«ã™ã‚‹
    # except json.JSONDecodeError as e:
    #     print(f"âŒ JSONãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: {e}")
    #     print("--- å¤±æ•—ã—ãŸãƒ†ã‚­ã‚¹ãƒˆ (ä¸Šè¨˜ãƒ­ã‚°å‚ç…§) ---")
    #     raise HTTPException(status_code=500, detail=f"AIãŒæœ‰åŠ¹ãªJSONã‚’è¿”ã—ã¾ã›ã‚“ã§ã—ãŸã€‚RAW: {final_text}")
    # except Exception as e:
    #     print(f"âŒ APIå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
    #     raise HTTPException(status_code=500, detail="AIã«ã‚ˆã‚‹ã‚¯ã‚¤ã‚ºç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")